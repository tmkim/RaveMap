{% include 'partials/header.html' %}
	<div class="container">
		<div class="box">
			<div class="search">
				<div class="change_city">

					<!-- use backend to show filter form;
						 enable/disable location, show slider value, query api -->

					<form class="search_form" action="change_city" method='GET'> <!-- action="backend.py" -->
						<button type="button" class="drop">Change City</button>
					</form>

					<!-- <form class="filter_form">
						<input type="radio" name="location" value="current" checked> Current Location<br>
						<input type="radio" name="location" value="other"> <input type="text" placeholder="Enter Zip Code" pattern="[0-9]{5}"><br>
						Distance: 0 mi.<input type="range" name="distance" min="0" max="100" step="5">100 mi.<br>
						<button type="submit" class="submit_search">Search</button>
					</form> -->

				</div>
				<div class="search_map">
					<input type=button onclick="searchBounds();" value="Search This Area">
				</div>
			</div>
			<br>
			<div id="map"></div>
		</div>
		<div class="box">
			<div class = "rave_list">
				<!-- {% for info in raves %}
					<li>{{info.name}} @ {{info.venue}} - {{info.date}}</li>
				{% endfor %} -->
			</div>
		</div>
	<div>
</body>
{% include 'partials/footer.html' %}
<script>
 var geocoder;
 var map;
 var markers = [];

 function initMap() {
	 	 map = new google.maps.Map(document.getElementById('map'), {
		 zoom: 12,
		 center: {lat: {{clat}}, lng: {{clng}}}
	 });
	 setMarkers();
 }

 function setMarkers() {
	 var info_window = new google.maps.InfoWindow();
	 var marker;

	 {% for v in venues %}
		 marker = new google.maps.Marker({
			 map: map,
			 position: {lat: {{v.latitude}}, lng: {{v.longitude}}}
		 });

		 google.maps.event.addListener(marker, 'click', (function(marker){
			 return function(){
					 info_window.setContent("{{v.name}}" + "<br>" + "{{v.address}}")
					 info_window.open(map, marker);

					 $.ajax({
						 url: '/ajax/show_raves/',
						 data: {
							 'venue_id': {{v.id}}
						 },
						 dataType: 'json',
						 success: function(data){
							 var rave_list_html = "<p class=\"list_title\">Raves at {{v.name}}:<p><ul>";
							 var raves = data.raves;

							 $.each(raves, function(r){
								 rave_list_html += "<li>" + raves[r].name + " - " + raves[r].date
								 + "<br>Featuring: " + raves[r].dj
								 + "<br><a target=\"_blank\" href=" + raves[r].tickets + ">Buy Tickets</a>"+ "</li>";
							 })
							 rave_list_html += "</ul>"

							 $('.rave_list').html(rave_list_html);
						 }
					 });
			 	}
		 })(marker));
		 markers.push(marker);
	 {% endfor %}

 }
	// google.maps.event.addDomListener(window, 'load', initialize);

	function searchBounds(){
		//remove old markers
		for (var x = 0; x < markers.length; x++){
			markers[x].setMap(null);
		}
		markers = [];

		//add new relevant markers
		var info_window = new google.maps.InfoWindow();
		var marker;

		var b = map.getBounds();
		var ne = b.getNorthEast();
		var sw = b.getSouthWest();

		$.ajax({
			url: '/ajax/search_map/',
			data:{
				'bounds': sw.lat(),
				'boundw': sw.lng(),
				'boundn': ne.lat(),
				'bounde': ne.lng()
			},
			dataType: 'json',
			success: function(data){
				var rave_list_html = "<p class=\"list_title\">New Venues Loaded<p><ul>";
				var venue_list = data.venues;

				$.each(venue_list, function(v){
				  marker = new google.maps.Marker({
			 		 map: map,
			 		 position: {lat: venue_list[v].lat, lng: venue_list[v].lng}
			 		});

		 		  google.maps.event.addListener(marker, 'click', (function(marker){
		 			 return function(){
		 					 info_window.setContent(venue_list[v].name + "<br>" + venue_list[v].address)
		 					 info_window.open(map, marker);

		 					 $.ajax({
		 						 url: '/ajax/show_raves/',
		 						 data: {
		 							 'venue_id': venue_list[v].id
		 						 },
		 						 dataType: 'json',
		 						 success: function(data){
		 							 var rave_list_html = "<p class=\"list_title\">Raves at " + venue_list[v].name + ":<p><ul>";
		 							 var raves = data.raves;

		 							 $.each(raves, function(r){
		 								 rave_list_html += "<li>" + raves[r].name + " - " + raves[r].date
		 								 + "<br>Featuring: " + raves[r].dj
		 								 + "<br><a target=\"_blank\" href=" + raves[r].tickets + ">Buy Tickets</a>"+ "</li>";
		 							 })
		 							 rave_list_html += "</ul>"

		 							 $('.rave_list').html(rave_list_html);
		 						 }
		 					 });
		 			 	}
		 		  })(marker));

					markers.push(marker);

					rave_list_html += "<li>" + venue_list[v].name + "</li>"
				})
				rave_list_html += "</ul>"

				$('.rave_list').html(rave_list_html)
			}
		});
	 }
</script>
<script src={{gmap_url}} async defer></script>
<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
